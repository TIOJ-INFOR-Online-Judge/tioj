<% set_page_title @problem.id.to_s + " - " + @problem.name %>
<% hide_old_submission = (!effective_admin? && @contest&.hide_old_submission) || @layout == :single_contest %>

<h4 class="page-header">
  <%= user_problem_status(current_user, @problem) if user_signed_in? %> <%= @problem.id %> . <%= @problem.name %>
</h4>

<div class="container-fluid d-grid row-gap-4">

  <div class="row gap-4">
    <%= render 'submit_button' %>
    <%= link_to @layout == :single_contest ? 'My Submissions' : 'Status', contest_adaptive_polymorphic_path([@problem, :submissions]), class: 'btn btn-info btn-sm col-md-2' %>
    <% unless @problem.discussion_disabled? or (@contest and @contest.disable_discussion? and @contest.is_running?) or @layout == :single_contest %>
      <%= link_to 'Discussion / Solution', problem_posts_path(@problem), class: 'btn btn-info btn-sm col-md-2' %>
    <% end %>
    <% if not hide_old_submission %>
      <%= link_to 'Ranklist', ranklist_problem_path(@problem), class: 'btn btn-dark btn-sm col-md-2' %>
    <% end %>
    <%= link_to 'Back to Problems List', @contest.blank? ? problems_path : contest_adaptive_polymorphic_path([]), class: 'btn btn-secondary btn-sm col-md-2' %>
  </div>
  <% if effective_admin? %>
    <div class="row gap-4">
      <%= link_to 'Edit', edit_problem_path(@problem), class: 'btn btn-info btn-sm col-md-2' %>
      <%= link_to 'Manage Testdata', problem_testdata_path(@problem), class: 'btn btn-warning btn-sm col-md-2' %>
      <% if @contest %>
        <%= button_to "Rejudge in Contest", rejudge_contest_problem_path(@contest, @problem), data: { confirm: "Are you really going to rejudge the whole problem in this contest? Out-of-contest submissions won't be affected." }, form_class: "col-md-2 p-0", class: "btn btn-dark btn-sm w-100" %>
      <% else %>
        <%= button_to "Rejudge", rejudge_problem_path(@problem), data: { confirm: "Are you really going to rejudge the whole problem? Contest submissions won't be affected." }, form_class: "col-md-2 p-0", class: "btn btn-dark btn-sm w-100" %>
      <% end %>
      <%= button_to "Delete All Submissions", delsub_problem_path(@problem), data: { confirm: "Are you really going to delete ALL submissions to this problem?" }, form_class: "col-md-2 p-0", class: "btn btn-danger btn-sm w-100" %>
    </div>
  <% end %>

  <% if not hide_old_submission %>
    <div class="row">
      <div class="col-md-4">
        <div class="card">
          <h6 class="card-header">
            TopCoder
          </h6>
          <div class="card-body">
            <% tcoder = topcoder(@problem) %>
            <% if tcoder %>
              <div class="row">
                <div class="col-lg col-lg-auto">
                  <%= link_to image_tag(tcoder.avatar.thumb.to_s, class: "img-thumbnail img-fluid"), user_path(tcoder) %>
                </div>
                <div class="col-lg">
                  <%= link_to tcoder.nickname, user_path(tcoder) %><br>
                  <blockquote class="motto blockquote"><dfn><%= tcoder.motto %></dfn></blockquote>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <h6 class="card-header">
                User's AC Ratio
              </h6>
              <div class="card-body">
                <%= users_ac_ratio(@problem) %>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <h6 class="card-header">
                Submission's AC Ratio
              </h6>
              <div class="card-body">
                <%= submissions_ac_ratio(@problem) %>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <h6 class="card-header">
            Tags
            <div style="float:right"><button id="toggle-solution-tag" type="button" class="btn btn-primary btn-sm">Show solution-related tags</button></div>

          </h6>
          <div class="card-body">
            <%= tag_list_html(@problem) %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="card">
    <h6 class="card-header">
      Description
    </h6>
    <div class="card-body">
      <%= markdown(@problem.description) %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <h6 class="card-header">
          Input Format
        </h6>
        <div class="card-body">
          <%= markdown(@problem.input) %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <h6 class="card-header">
          Output Format
        </h6>
        <div class="card-body">
          <%= markdown(@problem.output) %>
        </div>
      </div>
    </div>
  </div>

  <% @problem.sample_testdata.each_with_index do |sample, index| %>
    <div class="row">
      <div class="col-md-6">
        <div class="card copy-group problem-copy-group">
          <h6 class="card-header">
            Sample Input <%= index + 1 %>
          <% if sample.display_plaintext? %>
            <button class="btn btn-secondary btn-sm float-right copy-group-btn"> copy </button>
          <% end %>
          </h6>
          <div class="card-body">
            <% if sample.display_raw_html? %>
              <div class="mathjax_ignore sample-testdata"><%= raw sample.input.gsub(/\n/, '<br/>') %></div>
            <% elsif sample.display_markdown? %>
              <%= markdown(sample.input) %>
            <% else %>
              <pre class="copy-group-code sample-testdata"><%= sample.input %></pre>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card copy-group problem-copy-group">
          <h6 class="card-header">
            Sample Output <%= index + 1 %>
          <% if sample.display_plaintext? %>
            <button class="btn btn-secondary btn-sm float-right copy-group-btn"> copy </button>
          <% end %>
          </h6>
          <div class="card-body">
            <% if sample.display_raw_html? %>
              <div class="mathjax_ignore sample-testdata"><%= raw sample.output.gsub(/\n/, '<br/>') %></div>
            <% elsif sample.display_markdown? %>
              <%= markdown(sample.output) %>
            <% else %>
              <pre class="copy-group-code sample-testdata"><%= sample.output %></pre>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <h6 class="card-header">
          Hints
        </h6>
        <div class="card-body">
          <%= markdown(@problem.hint) %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <h6 class="card-header">
          Problem Source
        </h6>
        <div class="card-body">
          <%= markdown(@problem.source) %>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h6 class="card-header">
      Subtasks
    </h6>
    <table class="table table-hover table-striped table-sm">
      <% show_cons = @problem.subtasks.map{|s| s.constraints}.any?{|x| x && x.size > 0} %>
      <thead>
        <tr>
          <th width="5%">No.</th>
          <th width="20%">Testdata Range</th>
          <% if show_cons %>
            <th width="60%">Constraints</th>
          <% end %>
          <th width="15%">Score</th>
        </tr>
      </thead>
      <% @problem.subtasks.order(id: :asc).each_with_index do |s, i| %>
        <tr>
          <td><%= i + 1 %></td>
          <td><%= s.td_list.gsub(',', ', ').gsub('-', '~') %></td>
          <% if show_cons %>
            <td><%= markdown_no_p(s.constraints) %></td>
          <% end %>
          <td><%= sprintf("%g", s.score) %></td>
        </tr>
      <% end %>
    </table>
  </div>

  <div class="card">
    <h6 class="card-header" data-bs-toggle="collapse" href="#collapseLimit">
      Testdata and Limits
      <i class="indicator glyphicon glyphicon-chevron-up float-right"></i>
    </h6>
    <div class="collapse show" id="collapseLimit">
      <table class="table table-hover table-striped table-condensed">
        <thead>
          <tr>
            <th>No.</th>
            <th>Time Limit (ms)</th>
            <% if @has_vss %>
              <th>Memory Limit (VSS, KiB) <%= help_icon '/about/memory' %></th>
            <% end %>
            <% if @has_rss %>
              <th>Memory Limit (RSS, KiB) <%= help_icon '/about/memory' %></th>
            <% end %>
            <th>Output Limit (KiB)</th>
            <th>Subtasks</th>
          </tr>
        </thead>
        <tbody>
          <% @testdata.each_with_index do |testdatum, index| %>
            <tr>
              <td><%= index %></td>
              <td><%= testdatum.time_limit || "-" %></td>
              <% if @has_vss %>
                <td><%= testdatum.vss_limit || "-" %></td>
              <% end %>
              <% if @has_rss %>
                <td><%= testdatum.rss_limit || "-" %></td>
              <% end %>
              <td><%= testdatum.output_limit || "-" %></td>
              <td>
                <% if @tdlist[index] %>
                  <% @tdlist[index].each do |x| %>
                    <span class="subtask-icon"><%= x + 1 %></span>
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="container-fluid my-4">
  <div class="row gap-4">
    <%= render 'submit_button' %>
    <%= link_to 'Back to Top', '#', class: 'btn btn-secondary btn-sm col-md-2' %>
  </div>
</div>
