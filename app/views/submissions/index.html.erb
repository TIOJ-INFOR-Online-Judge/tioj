<% set_page_title "Submissions" %>

<% waiting_verdicts = ['Validating', 'queued', 'received'] %>
<% verdict_class_map = {
  "AC"     => "text-ac",
  "WA"     => "text-wa",
  "TLE"    => "text-tle",
  "MLE"    => "text-mle",
  "OLE"    => "text-ole",
  "RE"     => "text-re",
  "SIG"    => "text-sig",
  "queued" => "text-muted",
} %>
<% verdict_class_map.default = '' %>
<% waiting_submissions = [] %>

<h4 class="page-header">
  Submissions
  <% if @contest %>
    <small><%= @contest.title %></small>
  <% end %>
  <% if @problem %>
    <small>Problem #<%= @problem.id %></small>
  <% end %>
</h4>

<% if @problem %>
  <% submit_link = contest_adaptive_polymorphic_path([@problem, :submission], action: :new) %>
  <%= link_to 'Submit to Problem', submit_link, class: "btn btn-success btn-sm" %>
<% else %>
  <div class="row align-items-center gap-1">
    <div class="col-lg-auto">
      <label for="quick_prob_id">Quick Submit</label>
    </div>

    <div class="col-lg-2 px-lg-0">
      <input id="quick_prob_id" type="number" class="form-control form-control-sm" min="1" max="<%= Problem.count %>" placeholder="Enter Problem ID"/>
    </div>

    <div class="col-lg-auto">
      <a href="#" id="quick_submit" class="btn btn-success btn-sm">Submit</a>
    </div>
  </div>
<% end %>

<form class="row align-items-center gap-1" accept-charset="UTF-8" method="get">
  <div class="col-lg-auto">
    <label for="filter_user">Quick Filter</label>
  </div>

  <div class="col-lg-2 px-lg-0">
    <input id="filter_username" name="filter_username" class="form-control form-control-sm w-100" type="text" placeholder="Enter Username">
  </div>

  <div class="col-lg-2 px-lg-0">
    <input id="filter_problem" name="filter_problem" class="form-control form-control-sm" type="number" min="<%= Problem.order(id: :asc).first&.id %>" max="<%= Problem.order(id: :desc).first&.id %>" placeholder="Enter Problem ID">
  </div>

  <div class="col-lg-2 px-lg-0">
    <select id="filter_status" name="filter_status[]" class="form-select form-select-sm" multiple aria-label="Select Result">
      <option selected disabled value="">Select Result</option>
      <option value="AC">Accepted</option>
      <option value="WA">Wrong Answer</option>
      <option value="TLE">Time Limit Exceeded</option>
      <option value="MLE">Memory Limit Exceeded</option>
      <option value="OLE">Output Limit Exceeded</option>
      <option value="RE">Runtime Error</option>
      <option value="SIG">Runtime Error (signal)</option>
      <option value="CE">Compilation Error</option>
    </select>
  </div>

  <div class="col-lg-2 px-lg-0">
    <select id="filter_compiler" name="filter_compiler[]" class="form-select form-select-sm" multiple aria-label="Select Compiler">
      <option selected disabled value="">Select Compiler</option>
      <% Compiler.order(order: :asc).all.each do |x| %>
        <option value="<%= x.id %>"><%= x.name %></option>
      <% end %>
    </select>
  </div>

  <div class="col-lg-auto">
    <button type="submit" id="quick_filter" class="btn btn-dark btn-sm">Filter</button>
  </div>
</form>

<script>
  const tomselect_config = {
    create: true,
  };
  new TomSelect("#filter_status", tomselect_config);
  new TomSelect("#filter_compiler", tomselect_config);

  $("button:not([type='submit'])").attr("type", "button");
</script>

<table class='table table-hover table-striped'>
  <thead>
    <tr>
      <th>#</th>
      <th>PID</th>
      <% if @layout != :single_contest %>
        <th>Submitter</th>
      <% end %>
      <th>Time</th>
      <th>Memory</th>
      <th>Verdict</th>
      <th>Compiler</th>
      <th>Code Length</th>
      <th>Score</th>
      <th>Submit Time</th>
      <% if effective_admin? %>
        <th></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% @submissions.each do |submission| %>
      <tr>
        <% waiting_submissions.append(submission.id) if waiting_verdicts.include?(submission.result) %>
        <td><%= link_to submission.id, contest_adaptive_polymorphic_path([submission]) %></td>
        <td><%= link_to submission.problem_id, contest_adaptive_polymorphic_path([submission.problem]) %></td>
        <% if @layout != :single_contest %>
          <td><%= user_link(submission.user, submission.user.nickname) %></td>
        <% end %>
        <td id="time-<%= submission.id %>"><%= submission.total_time.to_i %></td>
        <td id="memory-<%= submission.id %>"><%= submission.total_memory.to_i %></td>
        <td id="verdict-<%= submission.id %>" class="<%= verdict_class_map[submission.result] %>"><%= submission.result %></td>
        <td><%= submission.compiler.name %></td>
        <td><%= number_to_human_size(submission.code_length) %></td>
        <td id="score-<%= submission.id %>"><%= sprintf("%g", submission.score) %></td>
        <td><%= submission.created_at.to_fs(:clean) %></td>
        <% if effective_admin? %>
          <td>
            <%= form_with url: rejudge_submission_path(submission) do |f| %>
              <%= f.submit 'Rejudge', class: 'btn btn-sm btn-primary' %>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>
<%= contest_adaptive_paginate @submissions %>

<% if not waiting_submissions.empty? %>
  <script>
    var verdict_class_map = <%= raw(verdict_class_map.to_json) %>;

    initSubmissionCable();
    $(document).ready(function() {
      subscribeSubmission(<%= raw(waiting_submissions.to_json) %>, updateMultipleSubmissions);
    });
  </script>
<% end %>
