<% set_page_title @contest.title %>

<% if @layout != :single_contest %>
  <% if effective_admin? %>
    <%= link_to "Alter Contest Announcement", contest_announcements_path(@contest), class: "btn btn-info btn-sm" %>
  <% end %>
  <%= link_to "Go to Single Contest page", single_contest_path(@contest), class: "btn btn-success btn-sm" %>
  <%= contest_registration_page_button(@contest, @register_status, true) %>

<% end %>

<h4 class="page-header">
  <%= @contest.title %>
</h4>

<div class="row">
  <div class="col-sm-6 <% if @layout == :single_contest %>col-lg-4<% else %>col-lg-3<% end %>">
    <div class="card bg-light mb-3">
      <h6 class="card-header">
        Start / End
      </h6>
      <div class="card-body">
        <%= @contest.start_time.to_fs(:clean) %> ~<br>
        <%= @contest.end_time.to_fs(:clean) %>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="card bg-light mb-3">
      <h6 class="card-header">
        Contest Type
      </h6>
      <div class="card-body">
        <%= contest_type_desc_map[@contest.contest_type] %><br>
        <% if @contest.dashboard_during_contest %>
          Dashboard<% if @contest.freeze_minutes > 0 %>, freezes <%= pluralize(@contest.freeze_minutes, 'minute') %> before end<% end %>
        <% else %>
          No dashboard
        <% end %>
      </div>
    </div>
  </div>
  <div class="<% if @layout == :single_contest %>col-sm-12 col-lg-4<% else %>col-sm-6 col-lg-3<% end %>">
    <div class="card bg-light mb-3">
      <h6 class="card-header">
        Register Before
      </h6>
      <div class="card-body">
        <%= @contest.effective_register_before.to_fs(:clean) %>
        <% unless @layout == :single_contest %>
          <br>
          <%= register_mode_desc_map[@contest.register_mode] %>
        <% end %>
      </div>
    </div>
  </div>
  <% unless @layout == :single_contest %>
    <div class="col-sm-6 col-lg-2">
      <div class="card bg-light mb-3">
        <h6 class="card-header">
          Registration Status
        </h6>
        <div class="card-body">
          <%= contest_register_status(@register_status, true) %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if effective_admin? || !(@contest.is_started? && @contest.user_can_submit?(current_user)) %>
  <div class="card bg-light mb-3">
    <h6 class="card-header">
      <% if effective_admin? %>
        Description before contest
      <% else %>
        Description
      <% end %>
    </h6>
    <div class="card-body">
      <%= markdown(@contest.description_before_contest) %>
    </div>
  </div>
<% end %>

<% if effective_admin? || (@contest.is_started? && @contest.user_can_submit?(current_user)) %>
  <div class="card bg-light mb-3">
    <h6 class="card-header">
      <% if effective_admin? %>
        Description in contest
      <% else %>
        Description
      <% end %>
    </h6>
    <div class="card-body">
      <%= markdown(@contest.description) %>
    </div>
  </div>
<% end %>

<% if effective_admin? %>
  <div class="mb-3 d-flex flex-wrap gap-1">
    <% Problem.visible_states.each do |name, val| %>
      <%= form_with url: set_contest_task_contest_path(@contest) do |f| %>
        <%= f.hidden_field :alter_to, value: val %>
        <%= f.submit "Set contest tasks to #{visible_state_desc_map[name.to_s]}", class: 'btn btn-dark btn-sm' %>
      <% end %>
    <% end %>
  </div>
<% end %>

<% unless @layout == :single_contest && (!user_signed_in? || !@contest.is_running?) %>
  <div class="card bg-light mb-3">
    <h6 class="card-header">
      Tasks
    </h6>
    <div class="card-body">
      <% if @contest.is_started? || current_user&.admin? %>
        <% @tasks.each_with_index do |task, index| %>
          <%= link_to (problem_index_text(index) + ' ' + task.id.to_s + '. ' + task.name), contest_adaptive_polymorphic_path([task]) %>
          <br>
        <% end %>
      <% else %>
        <%= 'Contest has not yet started.' %>
      <% end %>
    </div>
  </div>
<% end %>

<p>
  <%= link_to 'Dashboard', contest_adaptive_polymorphic_path([], action: :dashboard), {class: 'btn btn-sm btn-warning'} %>
  <%= link_to 'Submissions', contest_adaptive_polymorphic_path([:submissions]), class: 'btn btn-info btn-sm' %>
  <% if effective_admin? %>
    <%= link_to 'Edit', edit_contest_path(@contest), class: 'btn btn-info btn-sm' %>
  <% end %>
  <% if @layout != :single_contest %>
    <%= link_to 'Back to Contests List', contests_path, class: 'btn btn-secondary btn-sm' %>
  <% end %>
</p>
